{% extends "langchain/base.html" %}

{% block title %}Monitor Interview: {{ session.title if session and session.title else "Session" }}{% endblock %}

{% block extra_css %}
<style>
    .transcript-container {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        overflow-y: auto;
        margin-right: 20px;
        display: flex;
        flex-direction: column;
        flex: 2;
    }
    .controls-container {
        width: 350px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        flex: 1;
    }
    .status-indicator {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        background-color: #6c757d;
        margin-right: 5px;
    }
    .status-indicator.active {
        background-color: #28a745;
    }
    .transcript-content {
        flex: 1;
        white-space: pre-wrap;
        font-family: 'Inter', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        height: 65vh;
        overflow-y: auto;
    }
    .interviewer-message {
        color: #4f46e5;
        font-weight: 500;
        margin-bottom: 10px;
    }
    .participant-message {
        color: #212529;
        margin-bottom: 20px;
    }
    .control-label {
        font-weight: 500;
        margin-bottom: 5px;
    }
    .emotion-chart {
        height: 200px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
    }
    .sentiment-indicator {
        height: 25px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }
    .sentiment-level {
        position: absolute;
        height: 100%;
        background: linear-gradient(to right, #dc3545, #ffc107, #28a745);
        width: 100%;
    }
    .sentiment-marker {
        position: absolute;
        height: 25px;
        width: 3px;
        background-color: black;
        top: 0;
        z-index: 1;
    }
    .interview-stats {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }
    .interview-stats li {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 0.9rem;
    }
    .interview-stats .value {
        font-weight: 500;
    }
    .suggestion-box {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 20px;
        font-size: 0.9rem;
    }
    .live-indicator {
        display: inline-flex;
        align-items: center;
        padding: 5px 10px;
        background-color: rgba(220, 53, 69, 0.1);
        border-radius: 20px;
        color: #dc3545;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .live-indicator .dot {
        height: 8px;
        width: 8px;
        background-color: #dc3545;
        border-radius: 50%;
        margin-right: 5px;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
        100% {
            opacity: 1;
        }
    }
    .topic-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-bottom: 20px;
    }
    .topic-tag {
        background-color: #e9ecef;
        padding: 3px 8px;
        border-radius: 15px;
        font-size: 0.8rem;
    }
    .btn-toolbar {
        margin-top: auto;
    }
    .monitor-container {
        display: flex;
        gap: 20px;
    }
    
    /* AI Observer Styles */
    .ai-note {
        background-color: rgba(79, 70, 229, 0.05);
        border-left: 3px solid rgba(79, 70, 229, 0.5);
        padding: 8px 12px;
        margin-top: 5px;
        font-size: 0.9rem;
        color: #495057;
        font-style: italic;
    }
    .ai-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 5px;
    }
    .ai-tag {
        background-color: rgba(79, 70, 229, 0.1);
        color: #4f46e5;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
    }
    .mood-timeline {
        height: 100px;
        background-color: #f8f9fa;
        border-radius: 5px;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
        position: relative;
    }
    .mood-point {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: #4f46e5;
        transform: translate(-50%, -50%);
    }
    .observer-message {
        background-color: rgba(79, 70, 229, 0.03);
        border-radius: 8px;
        margin-bottom: 15px;
    }
    .observer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .observer-icon {
        color: #4f46e5;
        margin-right: 5px;
    }
    .observer-title {
        font-size: 0.8rem;
        font-weight: 500;
        color: #4f46e5;
    }
    .observer-status {
        font-size: 0.75rem;
        color: #6c757d;
    }
    .observer-content {
        padding: 10px 12px;
    }
    .tab-controls {
        margin-bottom: 15px;
    }
    .toggle-observer {
        display: inline-flex;
        align-items: center;
        font-size: 0.8rem;
        color: #495057;
        cursor: pointer;
        user-select: none;
        margin-bottom: 10px;
    }
    .toggle-observer input {
        margin-right: 5px;
    }
    .mood-indicator {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
    }
    .mood-label {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #6c757d;
    }
    .mood-bar {
        height: 5px;
        background: linear-gradient(to right, #dc3545, #ffc107, #28a745);
        border-radius: 2px;
        margin: 5px 0;
        position: relative;
    }
    .mood-marker {
        position: absolute;
        width: 10px;
        height: 10px;
        background-color: #212529;
        border-radius: 50%;
        top: -2.5px;
        transform: translateX(-50%);
        transition: left 0.3s ease;
    }
    .key-insights {
        background-color: rgba(79, 70, 229, 0.05);
        border-radius: 8px;
        padding: 10px;
        margin-top: 15px;
    }
    .insight-item {
        display: flex;
        margin-bottom: 8px;
    }
    .insight-item i {
        color: #4f46e5;
        margin-right: 8px;
        margin-top: 2px;
    }
    .quick-suggestion:hover, .direct-intervention:hover {
        transform: translateY(-2px);
        transition: transform 0.2s;
    }
    .ai-suggestion {
        border-left: 3px solid #198754;
        text-align: left;
        transition: all 0.2s ease;
    }
    .ai-suggestion:hover {
        background-color: rgba(25, 135, 84, 0.1);
        transform: translateX(3px);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3">Monitoring: {{ session.title if session and session.title else "Session" }}</h1>
            <div class="text-muted small">Session ID: {{ session_id }}</div>
        </div>
        <div class="d-flex align-items-center">
            <div class="live-indicator me-3">
                <span class="dot"></span> LIVE
            </div>
            <a href="/interview_details/{{ session_id }}" class="btn btn-sm btn-outline-secondary me-2">
                <i class="bi bi-info-circle me-1"></i> Session Details
            </a>
            <button id="end-session-btn" class="btn btn-sm btn-danger">
                <i class="bi bi-stop-circle me-1"></i> End Session
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- Transcript Column (Left) -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Transcript</h5>
                    <div>
                        <button id="refresh-btn" class="btn btn-sm btn-outline-secondary">
                            <i class="bi bi-arrow-clockwise me-1"></i> Refresh
                        </button>
                        <button id="copy-transcript-btn" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="bi bi-clipboard me-1"></i> Copy
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="transcript-content" class="transcript-content">
                        <!-- Transcript messages will appear here -->
                        {% if session and session.messages %}
                            {% for message in session.messages %}
                                <div class="{% if message.role == 'assistant' %}interviewer-message{% else %}participant-message{% endif %}" data-message-id="{{ message.id }}">
                                    <strong>{% if message.role == 'assistant' %}AI Interviewer{% else %}Participant{% endif %}:</strong> {{ message.content }}
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-dots fs-1 mb-3 d-block"></i>
                                <p>No messages yet. Waiting for the interview to begin...</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Researcher Controls -->
            <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Interview Controls</span>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="suggestion-input" class="form-label">Suggest a question or follow-up:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="suggestion-input" placeholder="Type a suggested question for the interviewer...">
                            <button class="btn btn-primary" id="send-suggestion-btn">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                        <div class="form-text">This will be sent as a suggestion to the interviewer.</div>
                    </div>
                    
                    <!-- Quick Suggestion Buttons -->
                    <div class="mb-4">
                        <label class="form-label">Quick Suggestions:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="Ask why">Ask why</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="Please elaborate">Please elaborate</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="Provide an example">Provide an example</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="How does that make you feel?">How does that feel?</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="What challenges did you face?">Challenges faced?</button>
                            <button class="btn btn-sm btn-outline-primary quick-suggestion" data-suggestion="What would you change?">What would you change?</button>
                        </div>
                    </div>
                    
                    <!-- AI Suggested Questions -->
                    <div class="mb-4">
                        <label class="form-label d-flex align-items-center">
                            <span>AI Suggested Questions:</span>
                            <span class="badge bg-primary ms-2"><i class="bi bi-robot"></i></span>
                            <button id="refresh-questions-btn" class="btn btn-sm btn-link p-0 ms-auto">
                                <i class="bi bi-arrow-clockwise"></i>
                            </button>
                        </label>
                        <div id="ai-suggested-questions" class="d-flex flex-column gap-2">
                            <div class="text-center text-muted small py-2">
                                <i class="bi bi-hourglass-split me-1"></i> Waiting for AI suggestions...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Intervention Options -->
                    <div class="mb-4">
                        <label class="form-label">Direct Interventions:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-warning direct-intervention" data-intervention="change-topic">
                                <i class="bi bi-arrow-right-circle"></i> Change Topic
                            </button>
                            <button class="btn btn-sm btn-info direct-intervention" data-intervention="pause">
                                <i class="bi bi-pause-circle"></i> Pause Briefly
                            </button>
                            <button class="btn btn-sm btn-success direct-intervention" data-intervention="go-deeper">
                                <i class="bi bi-arrow-down-circle"></i> Go Deeper
                            </button>
                            <button class="btn btn-sm btn-secondary direct-intervention" data-intervention="summarize">
                                <i class="bi bi-list-check"></i> Summarize So Far
                            </button>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <button class="btn btn-outline-primary" id="add-note-btn">
                            <i class="bi bi-journal-plus"></i> Add Research Note
                        </button>
                        <button class="btn btn-danger" id="end-interview-btn">
                            <i class="bi bi-x-circle"></i> End Interview
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Analytics Column (Right) -->
        <div class="col-lg-4">
            <!-- AI Observer Panel -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <h5 class="mb-0">AI Observer</h5>
                        <div class="ms-2">
                            <span class="badge bg-primary">
                                <i class="bi bi-robot"></i>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="me-2">
                            <span class="status-indicator"></span>
                            <span id="observer-status" class="text-muted small">Initializing</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tab-controls">
                        <label class="toggle-observer">
                            <input type="checkbox" id="observer-toggle" checked>
                            <span>Show AI observations</span>
                        </label>
                    </div>
                    
                    <!-- Current Participant Mood -->
                    <h6 class="mb-2">Participant Mood</h6>
                    <div class="mood-indicator">
                        <div class="mood-bar">
                            <div class="mood-marker" id="current-mood-marker" style="left: 50%;"></div>
                        </div>
                        <div class="mood-label">
                            <span>Negative</span>
                            <span>Neutral</span>
                            <span>Positive</span>
                        </div>
                    </div>
                    
                    <h6 class="mb-2">Mood Timeline</h6>
                    <div id="mood-timeline" class="mood-timeline">
                        <!-- Mood points will be added here -->
                    </div>
                    
                    <h6 class="mb-2">Detected Topics</h6>
                    <div id="topics-list" class="topic-list mb-3">
                        <!-- Topics will be added here -->
                    </div>
                    
                    <!-- AI Key Insights Section -->
                    <h6 class="mb-2">Key Insights</h6>
                    <div id="key-insights" class="key-insights mb-3">
                        <div class="text-center text-muted py-2">
                            <small>Insights will appear here as the interview progresses</small>
                        </div>
                    </div>
                    
                    <button id="generate-summary-btn" class="btn btn-primary w-100">
                        <i class="bi bi-lightbulb me-1"></i> Generate Insights
                    </button>
                </div>
            </div>
            
            <!-- Interview Stats -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Session Stats</h5>
                </div>
                <div class="card-body">
                    <ul class="interview-stats">
                        <li>
                            <span class="label">Duration</span>
                            <span class="value" id="session-duration">00:00:00</span>
                        </li>
                        <li>
                            <span class="label">Messages</span>
                            <span class="value" id="message-count">
                                {{ session.messages|length if session and session.messages else 0 }}
                            </span>
                        </li>
                        <li>
                            <span class="label">Avg. Response Time</span>
                            <span class="value" id="avg-response-time">--</span>
                        </li>
                        <li>
                            <span class="label">Interviewer Talk %</span>
                            <span class="value" id="interviewer-talk-percent">--</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Observer Summary Modal -->
<div class="modal fade" id="observerSummaryModal" tabindex="-1" aria-labelledby="observerSummaryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="observerSummaryModalLabel">AI Observer Summary</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Summary content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="copy-summary-btn">
                    <i class="bi bi-clipboard me-1"></i> Copy Summary
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Note Modal -->
<div class="modal fade" id="addNoteModal" tabindex="-1" aria-labelledby="addNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addNoteModalLabel">Add Research Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="note-text" class="form-label">Note:</label>
                    <textarea class="form-control" id="note-text" rows="4" placeholder="Add your research observation or note here..."></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Note Type:</label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="noteType" id="note-type-observation" value="observation" checked>
                        <label class="form-check-label" for="note-type-observation">
                            Observation
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="noteType" id="note-type-insight" value="insight">
                        <label class="form-check-label" for="note-type-insight">
                            Insight
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="noteType" id="note-type-question" value="question">
                        <label class="form-check-label" for="note-type-question">
                            Follow-up Question
                        </label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-note-btn">Save Note</button>
            </div>
        </div>
    </div>
</div>

<!-- End Interview Confirmation Modal -->
<div class="modal fade" id="endInterviewModal" tabindex="-1" aria-labelledby="endInterviewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="endInterviewModalLabel">End Interview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i> 
                    Are you sure you want to end this interview?
                </div>
                <p>This will terminate the session and redirect the participant to the thank you page. The system will automatically generate an analysis based on the interview transcript.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-end-interview-btn">End Interview</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM Elements
        const transcriptContainer = document.getElementById('transcript-content');
        const sendBtn = document.getElementById('send-suggestion-btn');
        const messageInput = document.getElementById('suggestion-input');
        const statusIndicator = document.querySelector('.status-indicator');
        const addNoteBtn = document.getElementById('add-note-btn');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const endInterviewBtn = document.getElementById('end-interview-btn');
        const confirmEndInterviewBtn = document.getElementById('confirm-end-interview-btn');
        
        // Session ID from the URL
        const sessionId = window.location.pathname.split('/').pop();
        
        // Check if required elements exist
        if (!sessionId) {
            console.error('Error: No session ID found in URL');
            alert('Error: No session ID found. Please return to dashboard and try again.');
            return;
        }
        
        if (!transcriptContainer) {
            console.error('Error: Transcript container element not found');
            return;
        }
        
        // WebSocket connection for real-time updates
        function setupWebSocket() {
            if (typeof io !== 'undefined') {
                window.socket = io();
                
                window.socket.on('connect', function() {
                    console.log('WebSocket connected');
                    
                    // Join the monitor room for this session
                    window.socket.emit('join_monitor_room', { session_id: sessionId });
                    console.log('Joined monitoring room for session:', sessionId);
                    updateConnectionStatus(true);
                    
                    // Request suggested questions and insights
                    console.log('Requesting suggested questions and insights');
                    window.socket.emit('request_suggested_questions', { session_id: sessionId });
                    window.socket.emit('request_insights', { session_id: sessionId });
                });
                
                window.socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus(false);
                });
                
                window.socket.on('connect_error', function(error) {
                    console.error('WebSocket connection error:', error);
                    updateConnectionStatus(false);
                });
                
                // Listen for new messages
                window.socket.on('new_message', function(data) {
                    if (data && data.message) {
                        console.log('Received new message:', data.message);
                        addMessageToTranscript(data.message);
                        highlightLatestMessage();
                    }
                });
                
                // Listen for observations
                window.socket.on('new_observation', function(data) {
                    if (data && data.observation) {
                        console.log('Received new observation:', data.observation);
                        addObservationNote(data.observation);
                        
                        // Update observer status to active
                        const statusElement = document.getElementById('observer-status');
                        const indicatorElement = document.querySelector('.status-indicator');
                        if (statusElement) {
                            statusElement.textContent = 'Active';
                            statusElement.classList.add('text-success');
                        }
                        if (indicatorElement) {
                            indicatorElement.classList.add('active');
                        }
                    }
                });
                
                // Listen for suggested questions
                window.socket.on('suggested_questions', function(data) {
                    console.log('Received suggested questions:', data);
                    if (data && data.questions) {
                        updateSuggestedQuestions(data.questions);
                    }
                });
                
                // Listen for insights
                window.socket.on('insights_update', function(data) {
                    console.log('Received insights update:', data);
                    if (data && data.insights) {
                        updateInsights(data.insights);
                    }
                });
                
                // Debug listener for any event
                const originalOnevent = window.socket.onevent;
                window.socket.onevent = function(packet) {
                    const args = packet.data || [];
                    console.log(`Received socket.io event: ${args[0]}`, args.slice(1));
                    originalOnevent.call(this, packet);
                };
            } else {
                console.error('Socket.io not loaded');
                setTimeout(setupWebSocket, 1000); // Try again in 1 second
            }
        }
        
        // Update insights UI
        function updateInsights(insights) {
            const container = document.getElementById('key-insights');
            if (!container) return;
            
            // Clear placeholder if present
            const placeholder = container.querySelector('.text-center.text-muted');
            if (placeholder) {
                placeholder.remove();
            }
            
            if (!insights || insights.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-2">
                        <small>No insights available yet</small>
                    </div>
                `;
                return;
            }
            
            // Add each insight
            insights.slice(0, 3).forEach(insight => {
                // Skip if this insight already exists
                if (document.querySelector(`.insight-item[data-id="${insight.id}"]`)) {
                    return;
                }
                
                // Create insight element
                const insightElem = document.createElement('div');
                insightElem.className = 'insight-item mb-3';
                insightElem.setAttribute('data-id', insight.id);
                
                // Format importance badge
                let importanceClass = 'bg-secondary';
                let importanceIcon = 'info-circle';
                
                if (insight.importance) {
                    const importance = insight.importance.toUpperCase();
                    if (importance.includes('HIGH')) {
                        importanceClass = 'bg-danger';
                        importanceIcon = 'exclamation-circle';
                    } else if (importance.includes('MEDIUM')) {
                        importanceClass = 'bg-warning text-dark';
                        importanceIcon = 'asterisk';
                    }
                }
                
                insightElem.innerHTML = `
                    <div class="d-flex align-items-start">
                        <i class="bi bi-lightbulb-fill text-primary me-2 mt-1"></i>
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="fw-medium">${insight.text}</span>
                                <span class="badge ${importanceClass} ms-2">
                                    <i class="bi bi-${importanceIcon} me-1"></i>
                                    ${insight.importance || 'MEDIUM'}
                                </span>
                            </div>
                            ${insight.evidence ? `<div class="text-muted small mt-1">${insight.evidence}</div>` : ''}
                        </div>
                    </div>
                `;
                
                // Insert at the top
                container.insertBefore(insightElem, container.firstChild);
            });
        }
        
        // Update connection status indicator
        function updateConnectionStatus(connected) {
            if (statusIndicator) {
                if (connected) {
                    statusIndicator.classList.add('active');
                    statusIndicator.title = 'Connected';
                } else {
                    statusIndicator.classList.remove('active');
                    statusIndicator.title = 'Disconnected';
                }
            }
        }
        
        // Session timer for duration calculation
        let sessionStartTime = Date.now();
        let sessionStatsUpdateInterval = null;
        
        // Function to calculate and update session statistics
        function updateSessionStats() {
            // Get all messages
            const messages = document.querySelectorAll('.interviewer-message, .participant-message');
            
            // Update message count
            const messageCount = document.getElementById('message-count');
            if (messageCount) {
                messageCount.textContent = messages.length;
            }
            
            // Calculate session duration if we have messages
            if (messages.length > 0) {
                const sessionDuration = document.getElementById('session-duration');
                if (sessionDuration) {
                    // Get timestamps from first and last messages
                    let firstTimestamp = Date.now() - 60000; // Default to 1 minute ago
                    let lastTimestamp = Date.now();
                    
                    // Try to get timestamps from message attributes
                    if (messages[0].hasAttribute('data-timestamp')) {
                        firstTimestamp = new Date(messages[0].getAttribute('data-timestamp')).getTime();
                    }
                    
                    if (messages[messages.length-1].hasAttribute('data-timestamp')) {
                        lastTimestamp = new Date(messages[messages.length-1].getAttribute('data-timestamp')).getTime();
                    }
                    
                    // Calculate duration
                    const durationMs = lastTimestamp - firstTimestamp;
                    const durationSec = Math.floor(durationMs / 1000);
                    const hours = Math.floor(durationSec / 3600);
                    const minutes = Math.floor((durationSec % 3600) / 60);
                    const seconds = durationSec % 60;
                    
                    // Format as HH:MM:SS
                    sessionDuration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Calculate average response time
                const avgResponseTime = document.getElementById('avg-response-time');
                if (avgResponseTime && messages.length >= 2) {
                    let totalResponseTime = 0;
                    let responseCount = 0;
                    
                    // Get timestamps and calculate time between messages
                    for (let i = 1; i < messages.length; i++) {
                        const currentMsg = messages[i];
                        const prevMsg = messages[i-1];
                        
                        // Only calculate when roles change (e.g., user->assistant or assistant->user)
                        if (currentMsg.className !== prevMsg.className) {
                            let currentTime = Date.now();
                            let prevTime = currentTime - 5000; // Default 5 seconds
                            
                            if (currentMsg.hasAttribute('data-timestamp')) {
                                currentTime = new Date(currentMsg.getAttribute('data-timestamp')).getTime();
                            }
                            
                            if (prevMsg.hasAttribute('data-timestamp')) {
                                prevTime = new Date(prevMsg.getAttribute('data-timestamp')).getTime();
                            }
                            
                            const responseTime = currentTime - prevTime;
                            if (responseTime > 0 && responseTime < 300000) { // Ignore responses over 5 minutes
                                totalResponseTime += responseTime;
                                responseCount++;
                            }
                        }
                    }
                    
                    // Format and display average
                    if (responseCount > 0) {
                        const avgTimeMs = Math.floor(totalResponseTime / responseCount);
                        const avgTimeSec = Math.floor(avgTimeMs / 1000);
                        
                        if (avgTimeSec < 60) {
                            avgResponseTime.textContent = `${avgTimeSec} sec`;
                        } else {
                            const minutes = Math.floor(avgTimeSec / 60);
                            const seconds = avgTimeSec % 60;
                            avgResponseTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} min`;
                        }
                    }
                }
                
                // Calculate interviewer talk percentage
                const interviewerTalkPercent = document.getElementById('interviewer-talk-percent');
                if (interviewerTalkPercent) {
                    const interviewerMessages = document.querySelectorAll('.interviewer-message');
                    const interviewerPercent = Math.round((interviewerMessages.length / messages.length) * 100);
                    interviewerTalkPercent.textContent = `${interviewerPercent}%`;
                }
            }
        }
        
        // Set an interval to update session stats every 10 seconds
        setInterval(updateSessionStats, 10000);
        
        // Call once at startup
        setTimeout(updateSessionStats, 1000);
        
        // Add message to transcript
        function addMessageToTranscript(message) {
            // Check if transcriptContainer exists before using it
            if (!transcriptContainer) {
                console.error('Error adding message to transcript: transcriptContainer element not found');
                return;
            }
            
            const messageElement = document.createElement('div');
            messageElement.className = `${message.role === 'assistant' ? 'interviewer-message' : 'participant-message'}`;
            messageElement.setAttribute('data-message-id', message.id);
            messageElement.setAttribute('data-timestamp', message.timestamp || Date.now());
            
            messageElement.innerHTML = `
                <strong>${message.role === 'assistant' ? 'AI Interviewer' : 'Participant'}:</strong> ${message.content}
            `;
            
            transcriptContainer.appendChild(messageElement);
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
            
            // Update session stats
            updateSessionStats();
        }
        
        // Highlight the most recent message
        function highlightLatestMessage() {
            const messages = document.querySelectorAll('.interviewer-message, .participant-message');
            messages.forEach(msg => msg.classList.remove('highlight'));
            
            const lastMessage = messages[messages.length - 1];
            if (lastMessage) {
                lastMessage.classList.add('highlight');
                setTimeout(() => {
                    lastMessage.classList.remove('highlight');
                }, 3000);
            }
        }
        
        // Add observation note to the sidebar
        function addObservationNote(observation) {
            if (!observation) return;
            
            // Update topics list if tags are present
            if (observation.tags && observation.tags.length > 0) {
                const topicsList = document.getElementById('topics-list');
                if (topicsList) {
                    observation.tags.forEach(tag => {
                        // Check if this tag already exists
                        if (!topicsList.querySelector(`.topic-tag[data-tag="${tag}"]`)) {
                            const tagElement = document.createElement('span');
                            tagElement.className = 'topic-tag';
                            tagElement.textContent = tag;
                            tagElement.setAttribute('data-tag', tag);
                            topicsList.appendChild(tagElement);
                        }
                    });
                }
            }
            
            // Update mood indicator if mood is present
            if (observation.mood !== undefined) {
                const moodMarker = document.getElementById('current-mood-marker');
                if (moodMarker) {
                    // Convert -10 to +10 scale to 0-100% scale
                    const moodPercent = ((observation.mood + 10) / 20) * 100;
                    moodMarker.style.left = `${moodPercent}%`;
                }
                
                // Add to mood timeline
                const moodTimeline = document.getElementById('mood-timeline');
                if (moodTimeline) {
                    const point = document.createElement('div');
                    point.className = 'mood-point';
                    // Position horizontally based on time (right = newer)
                    const horizontalPos = Math.random() * 90 + 5; // Random between 5-95%
                    // Position vertically based on mood (-10 = bottom, +10 = top)
                    const verticalPos = 100 - ((observation.mood + 10) / 20) * 100;
                    
                    point.style.left = `${horizontalPos}%`;
                    point.style.top = `${verticalPos}%`;
                    moodTimeline.appendChild(point);
                }
            }
            
            // Add note to key insights if it's an important type
            if (observation.insight_types && (observation.insight_types.includes('KEY_POINT') || observation.insight_types.includes('KEY_INSIGHT'))) {
                const keyInsights = document.getElementById('key-insights');
                if (keyInsights) {
                    // Clear placeholder if present
                    const placeholder = keyInsights.querySelector('.text-center.text-muted');
                    if (placeholder) {
                        placeholder.remove();
                    }
                    
                    const insight = document.createElement('div');
                    insight.className = 'insight-item';
                    insight.innerHTML = `
                        <i class="bi bi-lightbulb"></i>
                        <div>${observation.note}</div>
                    `;
                    keyInsights.appendChild(insight);
                }
            }
        }
        
        // Send a suggestion to the assistant
        function sendSuggestion() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            console.log('Preparing suggestion:', text);
            
            // First, just save the suggestion on the monitor side, don't send to remote interview yet
            if (window.socket && window.socket.connected) {
                window.socket.emit('send_suggestion', { 
                    session_id: sessionId,
                    suggestion: text
                });
                console.log('Suggestion prepared; ready for confirmation');
                
                // Find suggestion container - make sure it exists
                const suggestionInputContainer = document.querySelector('.suggestion-input-container');
                if (!suggestionInputContainer) {
                    console.error('Error: Could not find suggestion input container');
                    // Create a floating toast notification instead
                    showToastNotification('Suggestion prepared. Click to send to interview.', text);
                    messageInput.value = '';
                    return;
                }
                
                // Create a suggestion element with a confirmation button
                const suggestionArea = document.getElementById('pending-suggestions') || document.createElement('div');
                if (!document.getElementById('pending-suggestions')) {
                    suggestionArea.id = 'pending-suggestions';
                    suggestionArea.className = 'suggestions-area mt-3';
                    suggestionInputContainer.appendChild(suggestionArea);
                }
                
                const suggestionElement = document.createElement('div');
                suggestionElement.className = 'alert alert-info d-flex justify-content-between align-items-center';
                suggestionElement.innerHTML = `
                    <div class="flex-grow-1 me-2">
                        <strong>Prepared Suggestion:</strong> ${text}
                    </div>
                    <button class="btn btn-primary btn-sm confirm-suggestion">Send to Interview</button>
                `;
                
                suggestionArea.appendChild(suggestionElement);
                
                // Add event listener to confirmation button
                const confirmButton = suggestionElement.querySelector('.confirm-suggestion');
                confirmButton.addEventListener('click', function() {
                    sendConfirmedSuggestion(text);
                    suggestionElement.remove();
                });
                
                messageInput.value = '';
            } else {
                // Fallback to REST API for initial suggestion
                fetch(`/api/session/${sessionId}/suggestion`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: text,
                        type: 'suggestion'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Suggestion prepared on server side');
                        
                        // Find suggestion container - make sure it exists
                        const suggestionInputContainer = document.querySelector('.suggestion-input-container');
                        if (!suggestionInputContainer) {
                            console.error('Error: Could not find suggestion input container');
                            // Create a floating toast notification instead
                            showToastNotification('Suggestion prepared. Click to send to interview.', text);
                            messageInput.value = '';
                            return;
                        }
                        
                        // Create a suggestion element with confirmation button
                        const suggestionArea = document.getElementById('pending-suggestions') || document.createElement('div');
                        if (!document.getElementById('pending-suggestions')) {
                            suggestionArea.id = 'pending-suggestions';
                            suggestionArea.className = 'suggestions-area mt-3';
                            suggestionInputContainer.appendChild(suggestionArea);
                        }
                        
                        const suggestionElement = document.createElement('div');
                        suggestionElement.className = 'alert alert-info d-flex justify-content-between align-items-center';
                        suggestionElement.innerHTML = `
                            <div class="flex-grow-1 me-2">
                                <strong>Prepared Suggestion:</strong> ${text}
                            </div>
                            <button class="btn btn-primary btn-sm confirm-suggestion">Send to Interview</button>
                        `;
                        
                        suggestionArea.appendChild(suggestionElement);
                        
                        // Add event listener to confirmation button
                        const confirmButton = suggestionElement.querySelector('.confirm-suggestion');
                        confirmButton.addEventListener('click', function() {
                            sendConfirmedSuggestion(text);
                            suggestionElement.remove();
                        });
                        
                        messageInput.value = '';
                    } else {
                        console.error('Failed to prepare suggestion:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error preparing suggestion:', error);
                });
            }
        }
        
        // Helper function to show a floating toast notification if the container doesn't exist
        function showToastNotification(title, text) {
            // Create a floating toast that will be appended to the body
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background-color: white;
                border-left: 4px solid #4f46e5;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                padding: 15px;
                border-radius: 4px;
                z-index: 1050;
                max-width: 350px;
            `;
            
            toast.innerHTML = `
                <div class="d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong>${title}</strong>
                        <button type="button" class="btn-close btn-sm toast-close" aria-label="Close"></button>
                    </div>
                    <div class="toast-body mb-2">${text}</div>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary btn-sm toast-confirm">Send to Interview</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Add event listeners
            const closeBtn = toast.querySelector('.toast-close');
            const confirmBtn = toast.querySelector('.toast-confirm');
            
            closeBtn.addEventListener('click', function() {
                document.body.removeChild(toast);
            });
            
            confirmBtn.addEventListener('click', function() {
                sendConfirmedSuggestion(text);
                document.body.removeChild(toast);
            });
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 10000);
        }
        
        // Event listeners
        if (sendBtn) {
            sendBtn.addEventListener('click', sendSuggestion);
        }
        
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendSuggestion();
                }
            });
        }
        
        // Set up event listeners for quick suggestions
        document.querySelectorAll('.quick-suggestion').forEach(button => {
            button.addEventListener('click', function() {
                const suggestionText = this.getAttribute('data-suggestion');
                if (suggestionText) {
                    messageInput.value = suggestionText;
                    sendSuggestion();
                }
            });
        });
        
        // Set up event listeners for direct interventions
        document.querySelectorAll('.direct-intervention').forEach(button => {
            button.addEventListener('click', function() {
                const interventionType = this.getAttribute('data-intervention');
                if (interventionType) {
                    // Socket.io emission
                    if (window.socket && window.socket.connected) {
                        window.socket.emit('intervention', {
                            session_id: sessionId,
                            type: interventionType
                        });
                        console.log(`Applied intervention: ${interventionType}`);
                    } else {
                        // Fallback to REST API
                        fetch(`/api/session/${sessionId}/intervention`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                type: interventionType
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log(`Applied intervention: ${interventionType}`);
                            } else {
                                console.error('Error applying intervention:', data.error);
                            }
                        })
                        .catch(error => {
                            console.error('Network error applying intervention:', error);
                        });
                    }
                }
            });
        });
        
        // Update function for suggested questions
        function updateSuggestedQuestions(questions) {
            const container = document.getElementById('ai-suggested-questions');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!questions || questions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted small py-2">
                        <i class="bi bi-info-circle me-1"></i> No suggestions available yet
                    </div>
                `;
                return;
            }
            
            questions.forEach(question => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary ai-suggestion text-start p-2 mb-2';
                btn.innerHTML = question.text;
                btn.addEventListener('click', function() {
                    messageInput.value = question.text;
                    sendSuggestion();
                });
                container.appendChild(btn);
            });
        }
        
        // Refresh AI suggested questions
        const refreshQuestionsBtn = document.getElementById('refresh-questions-btn');
        if (refreshQuestionsBtn) {
            refreshQuestionsBtn.addEventListener('click', function() {
                if (window.socket && window.socket.connected) {
                    window.socket.emit('request_suggested_questions', { session_id: sessionId });
                    console.log('Requesting new question suggestions...');
                }
            });
        }
        
        // Generate AI insights
        const generateSummaryBtn = document.getElementById('generate-summary-btn');
        if (generateSummaryBtn) {
            generateSummaryBtn.addEventListener('click', function() {
                if (window.socket && window.socket.connected) {
                    window.socket.emit('request_insights', { session_id: sessionId });
                    console.log('Requesting new insights...');
                }
            });
        }
        
        // Function to send a confirmed suggestion to the remote interview
        function sendConfirmedSuggestion(suggestionText) {
            console.log('Sending confirmed suggestion to remote interview:', suggestionText);
            
            // Make API call to send the suggestion to the remote interview
            fetch(`/api/session/${sessionId}/send_confirmed_suggestion`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    suggestion: suggestionText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Suggestion sent to remote interview successfully');
                    
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.className = 'alert alert-success mt-2';
                    notification.innerHTML = `
                        <i class="bi bi-check-circle me-2"></i>
                        Suggestion sent to the interviewer
                    `;
                    document.querySelector('.suggestion-input-container').appendChild(notification);
                    
                    // Remove notification after 5 seconds
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                } else {
                    console.error('Failed to send suggestion to remote interview:', data.error);
                }
            })
            .catch(error => {
                console.error('Error sending suggestion to remote interview:', error);
            });
        }
        
        // Socket events for suggestion flow
        window.socket.on('suggestion_sent', function(data) {
            if (data && data.suggestion) {
                console.log('Got confirmation that suggestion was prepared:', data.suggestion.content);
            }
        });
        
        window.socket.on('suggestion_confirmed', function(data) {
            if (data && data.suggestion) {
                console.log('Suggestion was confirmed and sent to remote interview:', data.suggestion.content);
            }
        });
        
        // Set up WebSocket connection
        setupWebSocket();
    });
</script>
{% endblock %} 